"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const uuidV1 = require("uuid/v1");
const typedi_1 = require("typedi");
typedi_1.Container.of = function (instanceId) {
    if (instanceId === undefined) {
        return this.globalInstance;
    }
    var container = this.instances.find(function (instance) {
        return instance.id === instanceId;
    });
    if (!container) {
        container = new typedi_1.ContainerInstance(instanceId);
        container.services.push(...this.globalInstance.services.map(s => (Object.assign(Object.assign({}, s), { value: s.global ? s.value : undefined }))));
        this.instances.push(container);
    }
    return container;
};
exports.contextId = 'RpcServiceContextId';
const initCtx = (target, ctx) => {
    target.ctx = ctx;
    target.app = ctx.app;
    target.config = ctx.app.config;
    target.service = ctx.service;
    target[exports.contextId] = ctx[exports.contextId];
};
const injectContext = (obj, ctx) => {
    Object.getOwnPropertyNames(obj).map(prop => {
        if (obj[prop] && typeof obj[prop] === 'object') {
            const type = obj[prop].constructor;
            if (obj[exports.contextId] !== ctx[exports.contextId] && (typedi_1.Container.has(type) || typedi_1.Container.has(type.name))) {
                initCtx(obj[prop], ctx);
                injectContext(obj[prop], ctx);
            }
        }
    });
};
exports.getInstance = (ctx, classType) => {
    ctx[exports.contextId] = uuidV1();
    const instance = typedi_1.Container.of(ctx[exports.contextId]).get(classType);
    injectContext(instance, ctx);
    initCtx(instance, ctx);
    return instance;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5zdGFuY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvaW5zdGFuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrQ0FBa0M7QUFFbEMsbUNBQXNEO0FBRXRELGtCQUFTLENBQUMsRUFBRSxHQUFHLFVBQVMsVUFBVTtJQUNoQyxJQUFJLFVBQVUsS0FBSyxTQUFTLEVBQUU7UUFFNUIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDO0tBQzVCO0lBRUQsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBUyxRQUFRO1FBQ25ELE9BQU8sUUFBUSxDQUFDLEVBQUUsS0FBSyxVQUFVLENBQUM7SUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFDSCxJQUFJLENBQUMsU0FBUyxFQUFFO1FBQ2QsU0FBUyxHQUFHLElBQUksMEJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFOUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBRXJCLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsaUNBQ3BDLENBQUMsS0FDSixLQUFLLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsU0FBUyxJQUNyQyxDQUFDLENBQ0osQ0FBQztRQUVGLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQ2hDO0lBQ0QsT0FBTyxTQUFTLENBQUM7QUFDbkIsQ0FBQyxDQUFDO0FBRVcsUUFBQSxTQUFTLEdBQUcscUJBQXFCLENBQUM7QUFFL0MsTUFBTSxPQUFPLEdBQUcsQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLEVBQUU7SUFDOUIsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7SUFDakIsTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDO0lBQ3JCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7SUFDL0IsTUFBTSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDO0lBQzdCLE1BQU0sQ0FBQyxpQkFBUyxDQUFDLEdBQUcsR0FBRyxDQUFDLGlCQUFTLENBQUMsQ0FBQztBQUNyQyxDQUFDLENBQUM7QUFFRixNQUFNLGFBQWEsR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtJQUNqQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3pDLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLFFBQVEsRUFBRTtZQUM5QyxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDO1lBQ25DLElBQUksR0FBRyxDQUFDLGlCQUFTLENBQUMsS0FBSyxHQUFHLENBQUMsaUJBQVMsQ0FBQyxJQUFJLENBQUMsa0JBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksa0JBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7Z0JBQzFGLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3hCLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDL0I7U0FDRjtJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDO0FBRVcsUUFBQSxXQUFXLEdBQUcsQ0FBQyxHQUFZLEVBQUUsU0FBUyxFQUFFLEVBQUU7SUFDckQsR0FBRyxDQUFDLGlCQUFTLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQztJQUMxQixNQUFNLFFBQVEsR0FBRyxrQkFBUyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsaUJBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFNLFNBQVMsQ0FBQyxDQUFDO0lBQ2xFLGFBQWEsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDN0IsT0FBTyxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN2QixPQUFPLFFBQVEsQ0FBQztBQUNsQixDQUFDLENBQUMifQ==